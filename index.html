<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>N.O.R.A. Production Dashboard - Neumo HR Assistant</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .dashboard-container {
            max-width: 1800px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 280px 1fr 320px;
            gap: 20px;
            height: calc(100vh - 40px);
        }

        /* Sidebar Styles */
        .sidebar {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 24px;
        }

        .sidebar h2 {
            color: #667eea;
            font-size: 20px;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 2px solid #667eea;
        }

        /* Environment Badge */
        .env-badge {
            background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            text-align: center;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 16px;
        }

        .env-badge.production {
            background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);
        }

        .env-url {
            font-size: 10px;
            margin-top: 4px;
            opacity: 0.9;
            word-break: break-all;
        }

        /* Profile Cards */
        .profile-card {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 16px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .profile-card:hover {
            border-color: #667eea;
            transform: translateX(3px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
        }

        .profile-card.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #667eea;
            transform: translateX(0);
        }

        .profile-name {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 6px;
        }

        .profile-title {
            font-size: 13px;
            opacity: 0.85;
            margin-bottom: 10px;
        }

        .profile-badges {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }

        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 5px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .badge-exempt { background: #e3f2fd; color: #1976d2; }
        .badge-nonexempt { background: #fff3e0; color: #f57c00; }
        .badge-fulltime { background: #e8f5e9; color: #388e3c; }
        .badge-parttime { background: #fce4ec; color: #c2185b; }
        .badge-leader { background: #f3e5f5; color: #7b1fa2; }
        .badge-new { background: #ffebee; color: #c62828; }

        .profile-card.active .badge {
            background: rgba(255, 255, 255, 0.25);
            color: white;
        }

        /* Profile Details */
        .profile-details {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 16px;
            margin-top: auto;
        }

        .profile-details h3 {
            font-size: 14px;
            color: #667eea;
            margin-bottom: 12px;
            font-weight: 600;
        }

        .detail-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
            font-size: 12px;
        }

        .detail-item {
            display: flex;
            flex-direction: column;
            gap: 3px;
        }

        .detail-label {
            color: #666;
            font-weight: 600;
        }

        .detail-value {
            color: #333;
        }

        /* Main Chat Panel */
        .main-panel {
            background: white;
            border-radius: 12px;
            padding: 32px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .main-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 24px;
        }

        .main-header h1 {
            color: #667eea;
            font-size: 26px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #4caf50;
            animation: pulse 2s infinite;
        }

        .status-indicator.disconnected {
            background: #f44336;
            animation: none;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Chat Container - Fixed height for scrolling */
        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
            overflow: hidden;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            margin-bottom: 20px;
            scroll-behavior: smooth;
        }

        /* Custom Scrollbar */
        .chat-messages::-webkit-scrollbar {
            width: 8px;
        }

        .chat-messages::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        .chat-messages::-webkit-scrollbar-thumb {
            background: #667eea;
            border-radius: 10px;
        }

        .chat-messages::-webkit-scrollbar-thumb:hover {
            background: #5568d3;
        }

        /* Messages */
        .message {
            margin-bottom: 20px;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message-user {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 16px 20px;
            border-radius: 12px 12px 4px 12px;
            margin-left: auto;
            max-width: 70%;
            word-wrap: break-word;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .message-bot {
            background: white;
            border: 2px solid #e9ecef;
            padding: 16px 20px;
            border-radius: 12px 12px 12px 4px;
            max-width: 85%;
            word-wrap: break-word;
            line-height: 1.6;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .message-bot strong {
            color: #667eea;
        }

        .message-loading {
            background: white;
            border: 2px solid #e9ecef;
            padding: 20px;
            border-radius: 12px 12px 12px 4px;
            max-width: 85%;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .loading-dots {
            display: flex;
            gap: 6px;
        }

        .loading-dots span {
            width: 8px;
            height: 8px;
            background: #667eea;
            border-radius: 50%;
            animation: bounce 1.4s infinite ease-in-out both;
        }

        .loading-dots span:nth-child(1) { animation-delay: -0.32s; }
        .loading-dots span:nth-child(2) { animation-delay: -0.16s; }

        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }

        /* Input Area */
        .input-area {
            display: flex;
            gap: 12px;
            padding-top: 4px;
        }

        .input-area input {
            flex: 1;
            padding: 14px 18px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 15px;
            transition: all 0.2s;
        }

        .input-area input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .input-area button {
            padding: 14px 28px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .input-area button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(102, 126, 234, 0.4);
        }

        .input-area button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* Metrics Panel */
        .metrics-panel {
            display: flex;
            flex-direction: column;
            gap: 16px;
            overflow-y: auto;
        }

        .metric-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
            transition: transform 0.2s;
        }

        .metric-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.12);
        }

        .metric-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }

        .metric-title {
            font-size: 13px;
            color: #666;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .metric-value {
            font-size: 32px;
            font-weight: 700;
            color: #667eea;
            line-height: 1;
        }

        .metric-subtitle {
            font-size: 12px;
            color: #999;
            margin-top: 6px;
        }

        /* Confidence Bar */
        .confidence-container {
            margin-top: 10px;
        }

        .confidence-bar {
            height: 6px;
            background: #e9ecef;
            border-radius: 3px;
            overflow: hidden;
        }

        .confidence-fill {
            height: 100%;
            background: linear-gradient(90deg, #4caf50, #8bc34a);
            transition: width 0.5s ease;
        }

        .confidence-label {
            display: flex;
            justify-content: space-between;
            margin-top: 6px;
            font-size: 11px;
            color: #999;
        }

        /* Topics List */
        .topics-list {
            margin-top: 10px;
        }

        .topic-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: #f8f9fa;
            border-radius: 6px;
            margin-bottom: 6px;
            font-size: 12px;
        }

        .topic-name {
            color: #333;
            font-weight: 500;
        }

        .topic-count {
            background: #667eea;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 600;
        }

        /* Recent Activity */
        .activity-list {
            max-height: 200px;
            overflow-y: auto;
        }

        .activity-item {
            padding: 10px;
            background: #f8f9fa;
            border-radius: 6px;
            margin-bottom: 8px;
            font-size: 12px;
        }

        .activity-question {
            color: #333;
            font-weight: 500;
            margin-bottom: 4px;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .activity-meta {
            display: flex;
            justify-content: space-between;
            font-size: 11px;
            color: #999;
        }

        .activity-confidence {
            color: #4caf50;
            font-weight: 600;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .empty-state-text {
            font-size: 16px;
            font-weight: 500;
        }

        .empty-state-hint {
            font-size: 13px;
            margin-top: 8px;
        }

        /* Error State */
        .error-message {
            background: #ffebee;
            border: 2px solid #ef5350;
            color: #c62828;
            padding: 16px 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .error-message strong {
            color: #b71c1c;
        }

        /* Responsive */
        @media (max-width: 1400px) {
            .dashboard-container {
                grid-template-columns: 260px 1fr 280px;
            }
        }

        @media (max-width: 1200px) {
            .dashboard-container {
                grid-template-columns: 1fr;
                grid-template-rows: auto 1fr;
                height: auto;
                min-height: calc(100vh - 40px);
            }

            .sidebar, .metrics-panel {
                max-height: 400px;
            }

            .main-panel {
                min-height: 600px;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <!-- Left Sidebar: Profile Selection -->
        <div class="sidebar">
            <div class="env-badge production">
                ðŸš€ Production
                <div class="env-url">Cloud Run Service</div>
            </div>
            
            <h2>Test Profiles</h2>
            <div id="profileCards"></div>
            <div class="profile-details" id="profileDetails">
                <h3>Profile Details</h3>
                <p style="color: #999; font-size: 12px;">Select a profile to view details</p>
            </div>
        </div>

        <!-- Main Panel: Chat Interface -->
        <div class="main-panel">
            <div class="main-header">
                <h1>
                    N.O.R.A. Production Dashboard
                    <div class="status-indicator" id="statusIndicator" title="Connected"></div>
                </h1>
            </div>

            <div class="chat-container">
                <div class="chat-messages" id="chatMessages">
                    <div class="empty-state">
                        <div class="empty-state-icon">ðŸ’¬</div>
                        <div class="empty-state-text">Ready to assist!</div>
                        <div class="empty-state-hint">Select a profile and ask a question to get started</div>
                    </div>
                </div>

                <div class="input-area">
                    <input 
                        type="text" 
                        id="questionInput" 
                        placeholder="Ask a question about HR policies..."
                        onkeypress="if(event.key === 'Enter') askQuestion()"
                    >
                    <button id="askButton" onclick="askQuestion()">Send</button>
                </div>
            </div>
        </div>

        <!-- Right Panel: Metrics -->
        <div class="metrics-panel">
            <div class="metric-card">
                <div class="metric-header">
                    <span class="metric-title">Total Queries</span>
                </div>
                <div class="metric-value" id="totalQueries">0</div>
                <div class="metric-subtitle">This session</div>
            </div>

            <div class="metric-card">
                <div class="metric-header">
                    <span class="metric-title">Messages</span>
                </div>
                <div class="metric-value" id="messageCount">0</div>
                <div class="metric-subtitle">Back and forth</div>
            </div>

            <div class="metric-card">
                <div class="metric-header">
                    <span class="metric-title">Avg Confidence</span>
                </div>
                <div class="metric-value" id="avgConfidence">0%</div>
                <div class="confidence-container">
                    <div class="confidence-bar">
                        <div class="confidence-fill" id="confidenceFill" style="width: 0%"></div>
                    </div>
                    <div class="confidence-label">
                        <span>Low</span>
                        <span>High</span>
                    </div>
                </div>
            </div>

            <div class="metric-card">
                <div class="metric-header">
                    <span class="metric-title">Cache Hits</span>
                </div>
                <div class="metric-value" id="cacheHits">0</div>
                <div class="metric-subtitle">Cached responses</div>
            </div>

            <div class="metric-card">
                <div class="metric-header">
                    <span class="metric-title">Topics Discussed</span>
                </div>
                <div class="topics-list" id="topicsList">
                    <p style="color: #999; font-size: 12px; text-align: center; padding: 10px;">No topics yet</p>
                </div>
            </div>

            <div class="metric-card">
                <div class="metric-header">
                    <span class="metric-title">Recent Activity</span>
                </div>
                <div class="activity-list" id="activityList">
                    <p style="color: #999; font-size: 12px; text-align: center; padding: 10px;">No activity yet</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Production Cloud Run URL
        const API_BASE_URL = 'https://hr-chatbot-501344305052.us-east5.run.app';

        // Mock employee profiles for testing
        const employeeProfiles = {
            'sarah_exempt': {
                name: 'Sarah Johnson',
                title: 'Senior Marketing Manager',
                employment_classification: 'exempt',
                employment_status: 'full-time',
                role_type: 'individual_contributor',
                department: 'Marketing',
                manager: 'David Chen',
                direct_reports: 0,
                is_new_hire: false,
                years_of_service: '4 years',
                salary: '$95,000/year',
                pto_balance: '18 days',
                gender: 'Female',
                date_of_birth: '1988-03-15'
            },
            'mike_nonexempt': {
                name: 'Mike Rodriguez',
                title: 'Warehouse Associate',
                employment_classification: 'non-exempt',
                employment_status: 'full-time',
                role_type: 'individual_contributor',
                department: 'Operations',
                manager: 'Lisa Martinez',
                direct_reports: 0,
                is_new_hire: false,
                years_of_service: '2 years',
                salary: '$22.50/hour',
                pto_balance: '80 hours',
                gender: 'Male',
                date_of_birth: '1995-07-22'
            },
            'emily_leader': {
                name: 'Emily Chen',
                title: 'Director of Engineering',
                employment_classification: 'exempt',
                employment_status: 'full-time',
                role_type: 'people_manager',
                department: 'Engineering',
                manager: 'CTO',
                direct_reports: 12,
                is_new_hire: false,
                years_of_service: '6 years',
                salary: '$145,000/year',
                pto_balance: 'Unlimited',
                gender: 'Female',
                date_of_birth: '1985-11-08'
            },
            'alex_parttime': {
                name: 'Alex Thompson',
                title: 'Customer Service Rep',
                employment_classification: 'non-exempt',
                employment_status: 'part-time',
                role_type: 'individual_contributor',
                department: 'Customer Service',
                manager: 'Jennifer Smith',
                direct_reports: 0,
                is_new_hire: false,
                years_of_service: '1 year',
                salary: '$18.00/hour',
                pto_balance: '24 hours',
                gender: 'Non-binary',
                date_of_birth: '1998-05-12'
            },
            'jordan_new': {
                name: 'Jordan Williams',
                title: 'Junior Software Engineer',
                employment_classification: 'exempt',
                employment_status: 'full-time',
                role_type: 'individual_contributor',
                department: 'Engineering',
                manager: 'Emily Chen',
                direct_reports: 0,
                is_new_hire: true,
                years_of_service: '2 months',
                salary: '$75,000/year',
                pto_balance: '0 days',
                gender: 'Male',
                date_of_birth: '1999-09-30'
            }
        };

        // State management
        let currentProfile = 'sarah_exempt';
        let sessionId = generateSessionId();
        let messageCount = 0;
        let sessionMetrics = {
            totalQueries: 0,
            cacheHits: 0,
            confidenceScores: [],
            sensitiveTopics: {},
            recentActivity: []
        };

        function generateSessionId() {
            return 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        // Check API health on load
        async function checkAPIHealth() {
            try {
                const response = await fetch(`${API_BASE_URL}/health`);
                if (response.ok) {
                    document.getElementById('statusIndicator').classList.remove('disconnected');
                    document.getElementById('statusIndicator').title = 'Connected to Cloud Run';
                } else {
                    throw new Error('API unhealthy');
                }
            } catch (error) {
                document.getElementById('statusIndicator').classList.add('disconnected');
                document.getElementById('statusIndicator').title = 'Disconnected';
                console.error('API health check failed:', error);
            }
        }

        // Initialize on load
        window.onload = function() {
            renderProfiles();
            selectProfile('sarah_exempt');
            checkAPIHealth();
        };

        function renderProfiles() {
            const container = document.getElementById('profileCards');
            container.innerHTML = '';

            for (const [id, profile] of Object.entries(employeeProfiles)) {
                const card = document.createElement('div');
                card.className = 'profile-card';
                card.onclick = () => selectProfile(id);

                const badges = [];
                if (profile.employment_classification === 'exempt') {
                    badges.push('<span class="badge badge-exempt">Exempt</span>');
                } else {
                    badges.push('<span class="badge badge-nonexempt">Non-Exempt</span>');
                }

                if (profile.employment_status === 'full-time') {
                    badges.push('<span class="badge badge-fulltime">Full-Time</span>');
                } else {
                    badges.push('<span class="badge badge-parttime">Part-Time</span>');
                }

                if (profile.direct_reports > 0) {
                    badges.push('<span class="badge badge-leader">Leader</span>');
                }

                if (profile.is_new_hire) {
                    badges.push('<span class="badge badge-new">New Hire</span>');
                }

                card.innerHTML = `
                    <div class="profile-name">${profile.name}</div>
                    <div class="profile-title">${profile.title}</div>
                    <div class="profile-badges">${badges.join('')}</div>
                `;

                container.appendChild(card);
            }
        }

        function selectProfile(profileId) {
            // Update active state
            document.querySelectorAll('.profile-card').forEach((card, index) => {
                card.classList.remove('active');
            });
            const cards = document.querySelectorAll('.profile-card');
            const profileIds = Object.keys(employeeProfiles);
            const selectedIndex = profileIds.indexOf(profileId);
            if (selectedIndex >= 0) {
                cards[selectedIndex].classList.add('active');
            }

            currentProfile = profileId;

            // Generate new session ID when switching profiles
            sessionId = generateSessionId();
            
            // Clear chat
            const messagesDiv = document.getElementById('chatMessages');
            messagesDiv.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">ðŸ’¬</div>
                    <div class="empty-state-text">Ready to assist ${employeeProfiles[profileId].name}!</div>
                    <div class="empty-state-hint">Ask a question to get started</div>
                </div>
            `;

            // Reset metrics
            messageCount = 0;
            sessionMetrics = {
                totalQueries: 0,
                cacheHits: 0,
                confidenceScores: [],
                sensitiveTopics: {},
                recentActivity: []
            };
            updateMetricsDisplay();

            // Update profile details
            updateProfileDetails(profileId);
        }

        function updateProfileDetails(profileId) {
            const profile = employeeProfiles[profileId];
            const detailsHtml = `
                <h3>Profile Details</h3>
                <div class="detail-grid">
                    <div class="detail-item">
                        <div class="detail-label">Department</div>
                        <div class="detail-value">${profile.department}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Classification</div>
                        <div class="detail-value">${profile.employment_classification}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Status</div>
                        <div class="detail-value">${profile.employment_status}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Tenure</div>
                        <div class="detail-value">${profile.years_of_service}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Manager</div>
                        <div class="detail-value">${profile.manager}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Reports</div>
                        <div class="detail-value">${profile.direct_reports} direct</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Compensation</div>
                        <div class="detail-value">${profile.salary}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">PTO Balance</div>
                        <div class="detail-value">${profile.pto_balance}</div>
                    </div>
                </div>
            `;
            document.getElementById('profileDetails').innerHTML = detailsHtml;
        }

        async function askQuestion() {
            const input = document.getElementById('questionInput');
            const question = input.value.trim();
            
            if (!question) return;
            
            // Disable input
            input.disabled = true;
            document.getElementById('askButton').disabled = true;
            
            // Add user message
            addMessage('user', question);
            
            // Clear input
            input.value = '';
            
            // Show loading
            showLoading();
            
            try {
                const profile = employeeProfiles[currentProfile];
                
                // Build user context from profile
                const userContext = {
                    employment_classification: profile.employment_classification,
                    employment_status: profile.employment_status,
                    role_type: profile.role_type,
                    department: profile.department,
                    is_new_hire: profile.is_new_hire,
                    years_of_service: profile.years_of_service,
                    has_direct_reports: profile.direct_reports > 0
                };
                
                const response = await fetch(`${API_BASE_URL}/ask`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        question: question,
                        session_id: sessionId,
                        user_context: userContext
                    })
                });
                
                const data = await response.json();
                
                // Remove loading
                removeLoading();
                
                // Add bot response
                if (response.ok) {
                    addMessage('bot', data.answer);
                    
                    // Update metrics
                    sessionMetrics.totalQueries++;
                    sessionMetrics.confidenceScores.push(data.confidence || 0.5);
                    if (data.cached) {
                        sessionMetrics.cacheHits++;
                    }
                    
                    // Track sensitive topics
                    if (data.needs_escalation) {
                        const topic = 'escalation';
                        sessionMetrics.sensitiveTopics[topic] = (sessionMetrics.sensitiveTopics[topic] || 0) + 1;
                    }
                    
                    // Check for sensitive keywords in question/answer
                    const sensitiveKeywords = {
                        'compensation': /salary|pay|compensation|raise|bonus/i,
                        'termination': /termination|fired|dismissed|let go/i,
                        'medical': /medical|fmla|disability|illness|health/i,
                        'legal': /legal|lawsuit|attorney|discrimination/i,
                        'harassment': /harassment|hostile|abuse/i
                    };
                    
                    for (const [topic, pattern] of Object.entries(sensitiveKeywords)) {
                        if (pattern.test(question) || pattern.test(data.answer)) {
                            sessionMetrics.sensitiveTopics[topic] = (sessionMetrics.sensitiveTopics[topic] || 0) + 1;
                        }
                    }
                    
                    // Add to recent activity
                    sessionMetrics.recentActivity.unshift({
                        question: question,
                        confidence: data.confidence || 0.5,
                        timestamp: new Date()
                    });
                    
                    // Keep only last 10 activities
                    if (sessionMetrics.recentActivity.length > 10) {
                        sessionMetrics.recentActivity = sessionMetrics.recentActivity.slice(0, 10);
                    }
                    
                    // Update metrics display
                    updateMetricsDisplay();
                } else {
                    addMessage('bot', `<strong>Error:</strong> ${data.detail || 'Unable to get response'}`);
                }
                
            } catch (error) {
                console.error('Error:', error);
                removeLoading();
                addMessage('bot', `<strong>Error:</strong> Unable to connect to HR Assistant. The Cloud Run service may be unavailable.`);
                document.getElementById('statusIndicator').classList.add('disconnected');
            }
            
            // Re-enable input
            input.disabled = false;
            document.getElementById('askButton').disabled = false;
            input.focus();
        }

        function addMessage(type, content) {
            const messagesDiv = document.getElementById('chatMessages');
            
            // Remove empty state if present
            const emptyState = messagesDiv.querySelector('.empty-state');
            if (emptyState) {
                emptyState.remove();
            }
            
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message';
            
            const messageContent = document.createElement('div');
            messageContent.className = type === 'user' ? 'message-user' : 'message-bot';
            messageContent.innerHTML = formatMessage(content);
            
            messageDiv.appendChild(messageContent);
            messagesDiv.appendChild(messageDiv);
            
            // Scroll to bottom
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
            
            // Update message count
            if (type === 'user') {
                messageCount++;
            }
        }

        function formatMessage(text) {
            // Convert newlines to <br>
            let formatted = text.replace(/\n\n/g, '<br><br>').replace(/\n/g, '<br>');
            
            // Convert **text** to <strong> (bold)
            formatted = formatted.replace(/\*\*(.+?)\*\*/g, '<strong style="color: #667eea;">$1</strong>');
            
            // Convert *text* to <em> (italic)
            formatted = formatted.replace(/\*([^*]+?)\*/g, '<em>$1</em>');
            
            // Convert bullet points
            formatted = formatted.replace(/^â€¢\s+/gm, '<span style="color: #667eea; font-weight: bold;">&bull;</span> ');
            
            // Convert numbered lists
            formatted = formatted.replace(/^(\d+)\.\s+/gm, '<strong style="color: #667eea;">$1.</strong> ');
            
            return formatted;
        }

        function showLoading() {
            const messagesDiv = document.getElementById('chatMessages');
            
            // Remove empty state if present
            const emptyState = messagesDiv.querySelector('.empty-state');
            if (emptyState) {
                emptyState.remove();
            }
            
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'message';
            loadingDiv.id = 'loading-message';
            
            loadingDiv.innerHTML = `
                <div class="message-loading">
                    <div class="loading-dots">
                        <span></span>
                        <span></span>
                        <span></span>
                    </div>
                    <span style="color: #999; font-size: 14px;">N.O.R.A. is thinking...</span>
                </div>
            `;
            
            messagesDiv.appendChild(loadingDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function removeLoading() {
            const loadingDiv = document.getElementById('loading-message');
            if (loadingDiv) {
                loadingDiv.remove();
            }
        }

        function updateMetricsDisplay() {
            // Total queries
            document.getElementById('totalQueries').textContent = sessionMetrics.totalQueries;
            
            // Message count
            document.getElementById('messageCount').textContent = messageCount;
            
            // Cache hits
            document.getElementById('cacheHits').textContent = sessionMetrics.cacheHits;
            
            // Average confidence
            const avgConfidence = sessionMetrics.confidenceScores.length > 0
                ? sessionMetrics.confidenceScores.reduce((a, b) => a + b, 0) / sessionMetrics.confidenceScores.length
                : 0;
            document.getElementById('avgConfidence').textContent = Math.round(avgConfidence * 100) + '%';
            document.getElementById('confidenceFill').style.width = (avgConfidence * 100) + '%';
            
            // Topics list
            const topicsList = document.getElementById('topicsList');
            if (Object.keys(sessionMetrics.sensitiveTopics).length === 0) {
                topicsList.innerHTML = '<p style="color: #999; font-size: 12px; text-align: center; padding: 10px;">No topics yet</p>';
            } else {
                const topicsHtml = Object.entries(sessionMetrics.sensitiveTopics)
                    .map(([topic, count]) => `
                        <div class="topic-item">
                            <span class="topic-name">${topic}</span>
                            <span class="topic-count">${count}</span>
                        </div>
                    `).join('');
                topicsList.innerHTML = topicsHtml;
            }
            
            // Recent activity
            const activityList = document.getElementById('activityList');
            if (sessionMetrics.recentActivity.length === 0) {
                activityList.innerHTML = '<p style="color: #999; font-size: 12px; text-align: center; padding: 10px;">No activity yet</p>';
            } else {
                const activitiesHtml = sessionMetrics.recentActivity
                    .map(activity => {
                        const timeAgo = getTimeAgo(activity.timestamp);
                        const confidencePercent = Math.round(activity.confidence * 100);
                        return `
                            <div class="activity-item">
                                <div class="activity-question">${activity.question}</div>
                                <div class="activity-meta">
                                    <span>${timeAgo}</span>
                                    <span class="activity-confidence">${confidencePercent}%</span>
                                </div>
                            </div>
                        `;
                    }).join('');
                activityList.innerHTML = activitiesHtml;
            }
        }

        function getTimeAgo(timestamp) {
            const seconds = Math.floor((new Date() - timestamp) / 1000);
            if (seconds < 60) return 'Just now';
            const minutes = Math.floor(seconds / 60);
            if (minutes < 60) return `${minutes}m ago`;
            const hours = Math.floor(minutes / 60);
            return `${hours}h ago`;
        }
    </script>
</body>
</html>
